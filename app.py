# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1kKvBx_NvqGcmsSnXHAaZG3gFMseoSi7Y
"""

import streamlit as st
import pandas as pd
import numpy as np
import io
from datetime import date, timedelta

# --- Streamlit í˜ì´ì§€ ì„¤ì • ---
st.set_page_config(
    page_title="ì—‘ì…€ ë°ì´í„° ì²˜ë¦¬ê¸°",
    layout="centered",
    initial_sidebar_state="auto"
)

# ì œëª© ë° ì„¤ëª…
st.title("ğŸ“Š Excel ë°ì´í„° ì²˜ë¦¬ê¸° (ìŠ¤í¬ë¦½íŠ¸ ë²„ì „)")
st.markdown("ì œê³µëœ Python ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ì— ë”°ë¼ ì—‘ì…€ íŒŒì¼ì„ ì½ê³  ë°ì´í„°ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.")
st.caption("ì²˜ë¦¬í•  ì»¬ëŸ¼: G, H, K, M, X (ë‘ ë²ˆì§¸ í–‰ì„ í—¤ë”ë¡œ ê°„ì£¼í•˜ì—¬ ì½ìŒ)")

# --- ìƒìˆ˜ ë° ë§¤í•‘ ì •ì˜ ---

# ì—‘ì…€ì˜ ì»¬ëŸ¼ ìœ„ì¹˜ (0-based ì¸ë±ìŠ¤)
# G=6, H=7, K=10, M=12, X=23
# ì‚¬ìš©ìì˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì´ 5ê°œì˜ ì»¬ëŸ¼ë§Œ í•„ìš”ë¡œ í•¨
COLUMNS_TO_LOAD = ['G', 'H', 'K', 'M', 'X']

# pd.read_excelì— ì‚¬ìš©í•  ì»¬ëŸ¼ ì´ë¦„ (ìŠ¤í¬ë¦½íŠ¸ì˜ iloc ì¸ë±ìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •)
# G -> iloc[:, 0] -> ìµœì¢… ì—…ì²´ëª… (raw)
# H -> iloc[:, 1] -> ì¸ê³„ì¼ì
# K -> iloc[:, 2] -> ìœ„íƒëŸ‰
# M -> iloc[:, 3] -> ë°°ì¶œì°¨ëŸ‰ (raw)
# X -> iloc[:, 4] -> ì—…ì²´ëª….2
COLUMN_NAMES = [
    'ì—…ì²´ëª…_RAW',        # Column G
    'ì¸ê³„ì¼ì',          # Column H
    'ìœ„íƒëŸ‰',            # Column K
    'ë°°ì¶œì°¨ëŸ‰_RAW',      # Column M
    'ì—…ì²´ëª….2'           # Column X
]

# ì—…ì²´ëª….2 ëŒ€ì²´ ë§µ
REPLACEMENT_MAP = {
    'ìˆ˜ë„ê¶Œë§¤ë¦½ì§€ê´€ë¦¬ê³µì‚¬(ë°˜ì…íŒ€)': 'ë§¤ë¦½ì§€',
    'ë†ì—…íšŒì‚¬ë²•ì¸ ì„ê³„ (ì£¼)': 'ì„ê³„',
    'ì„œìš¸ë¬¼ì¬ìƒì‹œì„¤ê³µë‹¨-ì„œë‚¨ì„¼í„°': 'ì„œë‚¨',
    'ì„œìš¸íŠ¹ë³„ì‹œ ë‚œì§€ ë¬¼ì¬ìƒì„¼í„°': 'ë‚œì§€',
    'ì •ì• ì˜ë†ì¡°í•©ë²•ì¸': 'ì •ì• ì˜ë†',
    'ì¸ì²œí™˜ê²½ê³µë‹¨ ê°€ì¢Œì‚¬ì—…ì†Œ' : 'ê°€ì¢Œì‚¬ì—…ì†Œ',
    'ì „ì£¼ë¦¬ì‹¸ì´í´ë§ì—ë„ˆì§€(ì£¼)-ì™„ì‚°': 'ì „ì£¼',
    'ì„œìš¸ì‹œì¤‘ë‘ë¬¼ì¬ìƒì„¼í„°-ì²˜ë¦¬ì': 'ì¤‘ë‘',
    'ì¹ ì„±ì—ë„ˆì§€ ì˜ë†ì¡°í•©ë²•ì¸':'ì¹ ì„±ì—ë„ˆì§€'
}


# --- í•µì‹¬ ì²˜ë¦¬ í•¨ìˆ˜ (ì‚¬ìš©ì ìŠ¤í¬ë¦½íŠ¸ ê¸°ë°˜) ---

@st.cache_data
def process_excel_data_based_on_script(uploaded_file):
    """
    ì—…ë¡œë“œëœ ì—‘ì…€ íŒŒì¼ì„ ì½ê³  ì œê³µëœ pandas ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ì„ ì ìš©í•©ë‹ˆë‹¤.
    """
    if uploaded_file is None:
        return None, None, None, None

    # íŒŒì¼ì„ ë°”ì´íŠ¸ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ë³€í™˜
    data = io.BytesIO(uploaded_file.getvalue())

    try:
        # skiprows=1: ì²« ë²ˆì§¸ í–‰(0ë²ˆ ì¸ë±ìŠ¤) ìŠ¤í‚µ, 2ë²ˆì§¸ í–‰(1ë²ˆ ì¸ë±ìŠ¤)ì„ í—¤ë”ë¡œ ì½ìŒ
        # usecolsì™€ namesë¥¼ ì‚¬ìš©í•˜ì—¬ í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì •í™•íˆ ì§€ì •í•˜ê³  ì´ë¦„ ë¶€ì—¬
        df = pd.read_excel(
            data,
            header=1, # skiprows=1ê³¼ ë™ì¼í•œ íš¨ê³¼ (ë‘ ë²ˆì§¸ í–‰ì„ í—¤ë”ë¡œ ì‚¬ìš©)
            usecols=COLUMNS_TO_LOAD,
            names=COLUMN_NAMES,
            dtype={'ìœ„íƒëŸ‰': float}
        )
    except Exception as e:
        st.error(f"ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
        return None, None, None, None

    # -----------------------------------------------------
    # --- ë””ë²„ê¹… ì •ë³´ (ì²˜ë¦¬ ì „ ë°ì´í„°ì˜ ì²« 3í–‰) ---
    debug_raw_data = df.head(3).to_string(index=False)
    # -----------------------------------------------------

    # 1. ìœ„íƒëŸ‰ > 0 í•„í„°ë§
    df = df[df['ìœ„íƒëŸ‰'] > 0].copy()

    # 2. ë°°ì¶œì°¨ëŸ‰ ì²˜ë¦¬: ë’¤ì—ì„œ 4ìë¦¬ ì¶”ì¶œ ë° ìˆ«ì ë³€í™˜
    # df2['ë°°ì¶œì°¨ëŸ‰'] = df2.iloc[:, 3].str.replace(r'^.*(.{4})$', r'\1', regex=True)
    df['ë°°ì¶œì°¨ëŸ‰'] = df['ë°°ì¶œì°¨ëŸ‰_RAW'].astype(str).str.replace(r'^.*(.{4})$', r'\1', regex=True)
    df['ë°°ì¶œì°¨ëŸ‰'] = pd.to_numeric(df['ë°°ì¶œì°¨ëŸ‰'], errors='coerce') # ì—ëŸ¬ ë°œìƒ ì‹œ NaN ì²˜ë¦¬

    # 3. ì¸ê³„ì¼ì ì²˜ë¦¬: ì—°ë„ì™€ ì›”ì„ 1900-01ë¡œ ê³ ì •
    # df2['ì¸ê³„ì¼ì'] = df2['ì¸ê³„ì¼ì'].apply(lambda x: x.replace(year=1900, month=1))
    # datetime ê°ì²´ì—ë§Œ replaceê°€ ì‘ë™í•˜ë¯€ë¡œ, to_datetimeìœ¼ë¡œ ë³€í™˜ í›„ ì²˜ë¦¬
    def date_replace_1900_01(dt):
        if pd.isna(dt) or not isinstance(dt, (pd.Timestamp, datetime, date)):
            return pd.NaT
        return dt.replace(year=1900, month=1)

    df['ì¸ê³„ì¼ì'] = pd.to_datetime(df['ì¸ê³„ì¼ì'], errors='coerce')
    df['ì¸ê³„ì¼ì'] = df['ì¸ê³„ì¼ì'].apply(date_replace_1900_01)


    # 4. ì—…ì²´ëª….2 ì²˜ë¦¬: ë§¤í•‘ ëŒ€ì²´ ë° (ì£¼) ì œê±°
    df['ì—…ì²´ëª….2'] = df['ì—…ì²´ëª….2'].replace(REPLACEMENT_MAP)
    df['ì—…ì²´ëª….2'] = df['ì—…ì²´ëª….2'].astype(str).str.replace(r'\(ì£¼\)', '', regex=True)

    # 5. ìœ„íƒëŸ‰ ì²˜ë¦¬: 100 ë¯¸ë§Œ ì‹œ 1000 ê³±í•˜ê¸°
    df.loc[df['ìœ„íƒëŸ‰'] < 100, 'ìœ„íƒëŸ‰'] *= 1000

    # 6. ì¸ê³„ì¼ì ìµœì¢… í˜•ì‹ ì§€ì • ë° ì—…ì²´ëª… ìµœì¢… ì²˜ë¦¬
    # df2['ì¸ê³„ì¼ì'] = pd.to_datetime(df2['ì¸ê³„ì¼ì']).dt.date
    df['ì¸ê³„ì¼ì'] = df['ì¸ê³„ì¼ì'].dt.date # Timezone-naive date ê°ì²´ë¡œ ë³€í™˜

    # df2['ì—…ì²´ëª…']=df2.iloc[:,0].str.replace(r'\s+', '', regex=True)
    df['ì—…ì²´ëª…'] = df['ì—…ì²´ëª…_RAW'].astype(str).str.replace(r'\s+', '', regex=True) # ê³µë°± ì œê±°

    # 7. ìµœì¢… ì»¬ëŸ¼ ì„ íƒ ë° ìˆœì„œ ì§€ì •
    final_df = df[['ë°°ì¶œì°¨ëŸ‰', 'ì¸ê³„ì¼ì', 'ì—…ì²´ëª…', 'ì—…ì²´ëª….2', 'ìœ„íƒëŸ‰']].reset_index(drop=True)

    if final_df.empty:
        return pd.DataFrame(), None, debug_raw_data, None

    # 8. íŒŒì¼ ì´ë¦„ ìƒì„± (ì–´ì œ ë‚ ì§œ ê¸°ì¤€)
    current_date = date.today()
    yesterday = current_date - timedelta(days=1)
    file_name = f'new_data_{yesterday}.xlsx'

    return final_df, file_name, debug_raw_data, yesterday


# --- Streamlit UI êµ¬ì„± ---

uploaded_file = st.file_uploader(
    "1. ì—‘ì…€ íŒŒì¼ (.xlsx) ì—…ë¡œë“œ",
    type=['xlsx'],
    help="ì²˜ë¦¬í•  ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”. ë¡œì§ì€ 'skiprows=1'ì„ ì‚¬ìš©í•˜ì—¬ 2ë²ˆì§¸ í–‰ì„ í—¤ë”ë¡œ ì½ìŠµë‹ˆë‹¤."
)

if uploaded_file:
    # íŒŒì¼ì„ ì²˜ë¦¬í•˜ê³  ê²°ê³¼ë¥¼ ë°›ìŠµë‹ˆë‹¤.
    with st.spinner('ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...'):
        processed_df, output_filename, debug_info, yesterday = process_excel_data_based_on_script(uploaded_file)

    if processed_df is not None and not processed_df.empty:
        st.success(f"ì²˜ë¦¬ ì™„ë£Œ! ì´ {len(processed_df)}ê°œì˜ í–‰ì´ í•„í„°ë§ ë° ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.")

        # ë””ë²„ê·¸ ì •ë³´ (ì²˜ë¦¬ ì „ ë°ì´í„°ì˜ ì²« 3í–‰ê³¼ ì²˜ë¦¬ í›„ ë°ì´í„°ì˜ ì²« 3í–‰)
        with st.expander("ë””ë²„ê·¸ ì •ë³´ í™•ì¸"):
            st.subheader("RAW ë°ì´í„°ì˜ ì²« 3í–‰ (ì½ê¸° ì§í›„):")
            st.text(debug_info)
            st.subheader("ì²˜ë¦¬ëœ ë°ì´í„°ì˜ ì²« 3í–‰ (ìµœì¢…):")
            st.dataframe(processed_df.head(3), hide_index=True)

        # 2. ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
        # ì—‘ì…€ íŒŒì¼ë¡œ ë³€í™˜
        excel_buffer = io.BytesIO()
        processed_df.to_excel(excel_buffer, index=False, sheet_name='Processed Data')

        st.download_button(
            label=f"2. ì²˜ë¦¬ëœ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ({output_filename})",
            data=excel_buffer.getvalue(),
            file_name=output_filename,
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            type="primary",
            help=f"íŒŒì¼ ì´ë¦„ì€ {yesterday}ì„ ê¸°ì¤€ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤."
        )

    elif processed_df is not None and processed_df.empty:
        st.warning("í•„í„°ë§ ì¡°ê±´(ìœ„íƒëŸ‰ > 0)ì„ ë§Œì¡±í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
    else:
        # íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ëŠ” í•¨ìˆ˜ ë‚´ì—ì„œ ì²˜ë¦¬ë¨
        pass
else:
    st.info("ì‹œì‘í•˜ë ¤ë©´ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”. ")